version: "0.5"
networks:
  prod:
    hosts:
      - ubuntu@54.180.163.198
    env:
      DJANGO_SETTINGS_MODULE: settings.prod
env:
  HOME_DIR: /home/ubuntu
  REPO_DIR: $HOME_DIR/KUSITMS-application-server
  COMPOSE_FILE: $REPO_DIR/docker-compose.yml
commands:
  ping:
    run: uname -a
  upload:
    desc: upload specified file
    upload:
      - src: $src
        dst: $HOME_DIR/$dst
  upload_env:
    desc: upload .env file
    upload:
      - src: ./server/.env
        dst: $REPO_DIR
  checkout:
    desc: setup repository
    run: cd $REPO_DIR && git checkout master && git pull origin master
  build:
    desc: Build image
    run: docker-compose -f $COMPOSE_FILE build
  update:
    desc: Update image
    run: docker-compose -f $COMPOSE_FILE up -d
  env:
    run: env
targets:
  deploy:
    - checkout
    - upload_env
    - build
    - update
